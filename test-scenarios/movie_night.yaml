name: "Movie Night - Full Length"
description: "Person watches a 90-minute movie with virtual time compression"

# NEW: Virtual time configuration
test_mode:
  virtual_start: "2025-10-14T19:00:00Z"  # Evening movie time
  time_scale: 60  # 90 minutes becomes 1.5 minutes real time

setup:
  location: "living_room"
  initial_state:
    occupancy: null

events:
  # Person enters at 19:00 (virtual)
  - time: 0
    sensor: "motion:living_room"
    value: true
    description: "Person enters living room"

  # Occupancy detected at 19:00
  - time: 2
    type: occupancy
    location: living_room
    data:
      state: "occupied"
      confidence: 0.85
    description: "Occupancy detected"

  # Lights turn on at 19:00
  - time: 5
    type: lighting
    location: living_room
    data:
      state: "on"
      brightness: 80
      color_temp: 4000
      source: "automated"
    description: "Lights on"

  # Movie starts at 19:00 (virtual)
  - time: 10
    type: media
    location: living_room
    data:
      state: "playing"
      media_type: "video"
      source: "apple_tv"
    description: "Start movie"

  # Person dims lights at 19:00 (virtual)
  - time: 12
    type: lighting
    location: living_room
    data:
      state: "on"
      brightness: 15
      color_temp: 2700
      source: "manual"
    description: "Dim lights for movie"

  # Periodic subtle motion during movie to maintain occupancy
  - time: 900   # 15 minutes into movie
    sensor: "motion:living_room"
    value: true
    description: "Person adjusts position"

  - time: 1800  # 30 minutes into movie
    sensor: "motion:living_room" 
    value: true
    description: "Person shifts in seat"

  - time: 2700  # 45 minutes into movie
    sensor: "motion:living_room"
    value: true
    description: "Person gets snack"

  - time: 3600  # 60 minutes into movie
    sensor: "motion:living_room"
    value: true
    description: "Person stretches"

  - time: 4500  # 75 minutes into movie
    sensor: "motion:living_room"
    value: true
    description: "Person adjusts position"

  # Movie ends at 20:30 (virtual) = 90 minutes later
  # Real time: 90 seconds after start (5400 / 60)
  - time: 5400
    type: media
    location: living_room
    data:
      state: "stopped"
      media_type: "video"
    description: "Movie ends"

  # Person leaves at 20:35 (virtual)
  - time: 5700
    type: occupancy
    location: living_room
    data:
      state: "empty"
      confidence: 0.9
    description: "Person leaves"

expectations:
  behavior_events:
    - time: 5
      topic: "automation/behavior/episode/started"
      payload:
        location: "living_room"

    - time: 5760  # Check 60 seconds (1 minute virtual) after person leaves = 1 second real time for processing
      topic: "automation/behavior/episode/closed"
      payload:
        location: "living_room"
        end_reason: "occupancy_empty"

  postgres:
    - time: 5760
      postgres_query: "SELECT COUNT(*) FROM behavioral_episodes"
      postgres_expected: 1
      
    # Check that episode duration is ~90 minutes in virtual time
    - time: 5760
      postgres_query: |
        SELECT 
        EXTRACT(EPOCH FROM (
          (jsonld->>'jeeves:endedAt')::timestamptz - (jsonld->>'jeeves:startedAt')::timestamptz
        ))::int / 60 as duration_minutes
        FROM behavioral_episodes 
        ORDER BY id DESC 
        LIMIT 1
      postgres_expected: "~90"  # Should be approximately 90 minutes